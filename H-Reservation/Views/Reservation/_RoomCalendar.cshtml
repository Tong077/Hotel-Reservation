@{
    ViewData["Title"] = "Room Occupancy Calendar";
}

<div class="card shadow border-0 rounded-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="card-title mb-0">Room Occupancy Calendar</h4>
            <div class="d-flex align-items-center gap-2">
                <span id="calendarRange" class="fw-bold mr-2"></span>

                <select id="monthFilter" class="form-select form-select-sm btn btn-sm btn-outline-primary">
                    @for (int i = 1; i <= 12; i++)
                    {
                        <option value="@i">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)</option>
                    }
                </select>

                <button id="prevWeek" class="btn btn-outline-secondary btn-sm">◀ Previous</button>
                <button id="nextWeek" class="btn btn-outline-secondary btn-sm">Next ▶</button>
            </div>
        </div>

        <div id="loading" class="text-center my-3" style="display:none;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">Loading calendar...</p>
        </div>

        <div id="calendarContainerWrapper" style="max-height: 500px; overflow-y: auto;">
            <div id="calendarContainer" class="calendar-grid-container"></div>
        </div>
    </div>
</div>

<style>
    .calendar-grid-container {
        display: grid;
        grid-template-columns: 120px repeat(7, 1fr);
        gap: 1px;
        border: 1px solid #dee2e6;
        background-color: #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }

    .calendar-header {
        background-color: #f1f3f5;
        text-align: center;
        padding: 8px;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 2;
        border-bottom: 1px solid #dee2e6;
    }

    .calendar-room {
        background-color: #fff;
        text-align: center;
        font-weight: 600;
        padding: 8px;
        border-right: 1px solid #dee2e6;
    }

    .calendar-cell {
        min-height: 70px;
        border: 1px solid #dee2e6;
        text-align: center;
        font-size: 0.8rem;
        padding: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

        .calendar-cell small {
            display: block;
            line-height: 1.2;
        }

    .bg-success {
        background-color: #28a745 !important;
        color: #fff;
    }

    .bg-primary {
        background-color: #007bff !important;
        color: #fff;
    }

    .bg-info {
        background-color: #17a2b8 !important;
        color: #fff;
    }

    .bg-warning {
        background-color: #ffc107 !important;
        color: #000;
    }

    .bg-danger {
        background-color: #dc3545 !important;
        color: #fff;
    }

    .bg-secondary {
        background-color: #6c757d !important;
        color: #fff;
    }

    .bg-light {
        background-color: #f8f9fa !important;
        color: #000;
    }
</style>

<script>
    let currentStart = new Date();
    const daysToShow = 7;
    let calendarData = [];

    window.addEventListener('DOMContentLoaded', () => {
        const monthFilter = document.getElementById("monthFilter");
        monthFilter.value = new Date().getMonth() + 1;
        loadCalendar();
    });

    async function loadCalendar() {
        document.getElementById("loading").style.display = "block";

        // Calculate start/end dates
        const monthFilterValue = document.getElementById("monthFilter").value;
        let startDate = new Date(currentStart);
        let endDate = new Date(currentStart.getTime() + (daysToShow - 1) * 24 * 60 * 60 * 1000);

        if (monthFilterValue) {
            startDate = new Date(startDate.getFullYear(), monthFilterValue - 1, 1);
            endDate = new Date(startDate.getFullYear(), monthFilterValue, 0);
        }

        // Fetch calendar data from backend
        const res = await fetch(`/Reservation/GetCalendarData?startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`);
        const result = await res.json();
        calendarData = result.calendarData;

        // Generate date headers
        const dates = [];
        for (let i = 0; i < daysToShow; i++) {
            const d = new Date(currentStart);
            d.setDate(d.getDate() + i);
            dates.push(d);
        }

        document.getElementById("calendarRange").innerText =
            `${dates[0].toLocaleDateString('en-GB')} - ${dates[dates.length - 1].toLocaleDateString('en-GB')}`;

        // Rooms
        const rooms = [...new Set(calendarData.map(x => Number(x.roomNumber)))].sort((a,b)=>a-b);
        const container = document.getElementById("calendarContainer");
        container.innerHTML = "";

        // Header row
        container.innerHTML += `<div class="calendar-header">Room</div>`;
        dates.forEach(d => {
            const formatted = d.toLocaleDateString('en-GB', { weekday: 'short', month: 'short', day: 'numeric' });
            container.innerHTML += `<div class="calendar-header">${formatted}</div>`;
        });

        // Rows per room
        rooms.forEach(room => {
            container.innerHTML += `<div class="calendar-room">${room}</div>`;
            dates.forEach(date => {
                const cellDateStr = date.toISOString().split('T')[0];
                const cellData = calendarData.find(x =>
                    Number(x.roomNumber) === room &&
                    new Date(x.date).toISOString().split('T')[0] === cellDateStr
                );

                const status = cellData?.status || "Available";
                const color = {
                    "CheckedIn": "bg-success",
                    "Confirmed": "bg-primary",
                    "CheckedOut": "bg-info",
                    "Pending": "bg-warning",
                    "Cancelled": "bg-danger",
                    "Cleaning": "bg-secondary",
                    "Available": "bg-light"
                }[status] || "bg-light";

                const guestName = cellData?.guestName || "Available";
                container.innerHTML += `
                    <div class="calendar-cell ${color}"
                         data-room="${room}"
                         data-date="${date.toISOString()}"
                         draggable="${status !== 'Available' && status !== 'CheckedOut'}"
                         ondragstart="onDragStart(event)"
                         ondragover="onDragOver(event)"
                         ondrop="onDrop(event)"
                         title="${guestName} (${status})">
                        <small><strong>${status}</strong> – ${guestName}</small>
                    </div>`;

              });
        });

        document.getElementById("loading").style.display = "none";
    }

    // ===== Drag & Drop Logic =====
    let dragged = null;

    function onDragStart(e) {
        const room = e.target.dataset.room;
        const date = e.target.dataset.date.split('T')[0];
        const cell = calendarData.find(c => c.roomNumber == room && c.date.split('T')[0] === date);
        if (!cell || cell.status === "CheckedOut") {
            e.preventDefault();
            return;
        }
        dragged = { roomNumber: room, date, status: cell.status };
        e.dataTransfer.effectAllowed = "move";
    }

    function onDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
    }

    async function onDrop(e) {
        e.preventDefault();
        const newRoom = e.target.dataset.room;
        if (!dragged || !newRoom || dragged.roomNumber === newRoom) return;

        if (!confirm(`Move reservation from room ${dragged.roomNumber} → ${newRoom}?`)) return;

        const payload = {
            OldRoomNumber: dragged.roomNumber,
            NewRoomNumber: newRoom
        };

        const res = await fetch('/Reservation/MoveReservation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert("Room switched successfully!");
            loadCalendar();
        } else {
            const error = await res.text();
            alert("Error: " + error);
        }

        dragged = null;
    }

    // ===== Manual status update =====
    function updateStatus(roomNumber, date, currentStatus) {
        const newStatus = prompt(`Update status for Room ${roomNumber} on ${new Date(date).toLocaleDateString()}:\n(Current: ${currentStatus || "Empty"})`, currentStatus);
        if (!newStatus) return;

        fetch('/Reservation/UpdateStatus', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roomNumber, date, newStatus })
        })
        .then(response => {
            if (!response.ok) throw new Error("Failed to update status");
            return response.json();
        })
        .then(() => loadCalendar())
        .catch(err => alert(err.message));
    }

    // ===== Navigation =====
    document.getElementById("prevWeek").addEventListener("click", () => {
        currentStart.setDate(currentStart.getDate() - daysToShow);
        loadCalendar();
    });

    document.getElementById("nextWeek").addEventListener("click", () => {
        currentStart.setDate(currentStart.getDate() + daysToShow);
        loadCalendar();
    });

    document.getElementById("monthFilter").addEventListener("change", () => loadCalendar());
</script>
